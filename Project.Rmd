---
title: "Analisi house price"
output: html_document
---

# Importazione delle librerie

``` {r, message = T, warning = F}
if (!require("ggplot2", quietly = T))
  install.packages("ggplot2")
library(ggplot2)
if (!require("dplyr", quietly = T))
  install.packages("dplyr")
library(dplyr)
if (!require("ggcorrplot", quietly = T))
  install.packages("ggcorrplot")
library(ggcorrplot)
if (!require("GGally", quietly = T))
  install.packages("GGally")
library(GGally)
if (!require("reshape2", quietly = T))
  install.packages("reshape2")
library(reshape2)
if (!require("gridExtra", quietly = T))
  install.packages("gridExtra")
library(gridExtra)

plot_theme = theme_minimal() +
    theme(
        plot.title = element_text(face = "bold", hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        axis.line = element_line(color = "darkgrey"),
        axis.ticks = element_line(color = "black"))
theme_set(plot_theme)
```

# Importazione dei dati

```{r, warning = F}
HP <- read.csv2(
    "./dataset.csv",
    sep = ",", 
    stringsAsFactors = T,
    row.names=1)

attach(HP)
```

# Distribuzione dei prezzi delle case

``` {r,warning = F}
SalePrice.summary <- summary(SalePrice)

print(SalePrice.summary)
```

``` {r,warning = F}
ggplot(HP, aes(x = SalePrice)) +
    geom_density() +
    xlab("Prezzo di vendita") +
    ylab("Densità") +
    geom_vline(aes(xintercept = SalePrice.summary["1st Qu."], colour = "1° Quantile"), linetype = "dashed") +
    geom_vline(aes(xintercept = SalePrice.summary["Mean"], colour = "Media"), linetype = "dashed") +
    geom_vline(aes(xintercept = SalePrice.summary["Median"], colour = "Mediana"), linetype = "dashed") +
    geom_vline(aes(xintercept = SalePrice.summary["3rd Qu."], colour = "3° Quantile"), linetype = "dashed") +
    labs(colour = "Statistiche") +
    scale_color_manual(labels = c("1° Quantile", "3° Quantile", "Media", "Mediana"), values = c("green", "darkgreen", "red", "blue"))
```
``` {r,warning = F}
ggplot(HP, aes(x = SalePrice)) +
    geom_boxplot() +
    xlab("Prezzo di vendita")
```

Possiamo dedurre che la distribuzione è positivamente asimetrica e che la maggior parte del prezzo di vendita è compresa tra 129.975 e 214.000, essendo rispettivamente il 1° e il 3° quantile.
Si può dedurre che sono una piccola parte delle case vendute siano ville di lusso, case lussuose o immobili di alto valore, ma la maggior parte del mercato immobiliare di concentri sulla vendita di piccoli o medi immobili.

# Matrice di correlazione

Prima di tutto identifico le variabili su cui ha senso fare una correlazione con il prezzo
``` {r,warning = F}

Heapmap.vars <- c("MSSubClass", "MSZoning", "LotFrontage", "LotArea", "LotShape", "LotConfig", "Neighborhood", "BldgType", "HouseStyle", "OverallQual", "OverallCond", "YearBuilt", "YearRemodAdd", "Exterior1st", "ExterQual", "ExterCond", "Foundation", "BsmtQual", "BsmtCond", "BsmtExposure", "BsmtFinSF1", "BsmtFinSF2", "TotalBsmtSF", "HeatingQC", "X1stFlrSF", "X2ndFlrSF", "GrLivArea", "FullBath", "HalfBath", "BedroomAbvGr", "KitchenQual", "TotRmsAbvGrd", "GarageType", "GarageCars", "GarageArea", "GarageQual", "GarageCond", "OpenPorchSF", "EnclosedPorch", "ScreenPorch", "Fence", "MiscFeature", "MiscVal", "MoSold", "YrSold", "SalePrice")
selected_vars = HP[Heapmap.vars]
convert_to_numeric <- function(x) {
  if (is.factor(x) || is.character(x)) {
    as.numeric(factor(x, levels = unique(x)))
  } else {
    return(x)
  }
}

selected_data <- selected_vars %>%
  mutate(across(everything(), ~ convert_to_numeric(.))
  )

selected_data_numeric <- selected_data %>%
  mutate(across(everything(), ~ as.numeric(as.character(.))))

corHeap = as.data.frame(round(cor(selected_data_numeric, HP$SalePrice),2))

names(corHeap) = "SalePrice"

withNA = rownames(corHeap)[is.na(corHeap$SalePrice)]

for (ele in withNA){
  HP_lotfrontage = selected_data_numeric[[ele]][which(!is.na(selected_data_numeric[[ele]]))]
  HP_lotfrontageSALE = selected_data_numeric$SalePrice[which(!is.na(selected_data_numeric[[ele]]))]
  corHeap[ele,"SalePrice"] = cor(HP_lotfrontageSALE,HP_lotfrontage)
}
```

ora si può visualizzare il vettore di correlazione come
``` {r,warning = F}
length_corHeap = ceiling(NROW(corHeap)/2)

first_half_corHeap = as.data.frame(corHeap[1:length_corHeap,])
rownames(first_half_corHeap) = rownames(corHeap)[1:length_corHeap]
names(first_half_corHeap) = "SalePrice"
length_corHeap = 1 + length_corHeap
second_half_corHeap = as.data.frame(corHeap[length_corHeap:NROW(corHeap),])
rownames(second_half_corHeap) = rownames(corHeap)[length_corHeap:NROW(corHeap)]
names(second_half_corHeap) = "SalePrice"

p1 = ggcorrplot(first_half_corHeap, type = "lower", lab=TRUE, lab_size = 2.5)+
  theme(
  axis.text.x = element_text(size = 9),
  axis.text.y = element_text(size = 9)
  )
p2 = ggcorrplot(second_half_corHeap, type = "lower", lab=TRUE, lab_size = 2.5)+
  theme(
  axis.text.x = element_text(size = 9),
  axis.text.y = element_text(size = 9)
  )
grid.arrange(p1,p2,nrow=2)
```

e filtrarlo per avere solo le variabili che hanno correlazione con SalePrice >=0.6
``` {r,warning = F}
par(mfrow=c(2,3))
for (var in rownames(corHeap)[rownames(corHeap) != "SalePrice" & (corHeap>=0.6 | corHeap<= -0.6)]){
  plot(SalePrice~HP[[var]], xlab=var)
}
```

## Variabili calcolate

Prendo le variabili escluse dal pair plot come ad esempio e provo a creare delle variabili calcolate che potrebbero essere correlate a SalePrice. 
Ad esempio variabili quantitative o qualitative che hanno valori NA o 0 per indicare l'assenza di quella caratteristica le trasformo in variabili booleane.
```{r, message = F}
current_year <- as.integer(format(Sys.Date(), "%Y"))

HP$FrontageExists <- factor(!is.na(LotFrontage), levels = c(F, T), labels = c("no", "yes"))
HP$HouseAge <- current_year - YearBuilt
HP$GarageExists <- factor(!is.na(GarageType), levels = c(F, T), labels = c("no", "yes"))
HP$OpenPorchExists <- factor(OpenPorchSF != 0, levels = c(F, T), labels = c("no", "yes"))
HP$EnclosedPorchExists <- factor(EnclosedPorch != 0, levels = c(F, T), labels = c("no", "yes"))
HP$ScreenPorchExists <- factor(ScreenPorch != 0, levels = c(F, T), labels = c("no", "yes"))

attach(HP)
```

ora procedo a metterle in correlazione con SalePrice in un heatmap
```{r, warning = F}
vars <- c("FrontageExists", "HouseAge", "GarageExists", "OpenPorchExists", "EnclosedPorchExists", "ScreenPorchExists")

corHeap <- matrix(
    rep(0, length(vars)), 
    ncol = 1, 
    dimnames = list(vars, c("SalePrice")))

for (v in vars){
    corHeap[v, "SalePrice"] = cor(as.numeric(HP[, v]), SalePrice)
}

ggcorrplot(corHeap, type = "lower", lab=TRUE, lab_size = 2.5) + 
    theme(
        axis.text.x = element_text(size = 9),
        axis.text.y = element_text(size = 9))
```

# Analisi bivariata

Trasformo le variabili opportune in factor
```{r, message = F, warning = F}

for (f in c("ExterQual", "ExterCond", "BsmtQual", "BsmtCond", "HeatingQC", "KitchenQual", "GarageQual", "GarageCond")) {
    HP[, f] <- factor(
        HP[, f],
        levels = c("Po", "Fa", "TA", "Gd", "Ex"),
        labels = c("Poor", "Fair", "Average", "Good", "Excellent"))
}
HP[,"OverallQual"] = factor(HP[,"OverallQual"],
                            levels = c(1,2,3,4,5,6,7,8,9,10),
                            labels = c( "Very Poor",
                                        "Poor",
                                        "Fair",
                                        "Below Average",
                                        "Average",
                                        "Above Average",
                                        "Good",
                                        "Very Good",
                                        "Excellent",
                                        "Very Excellent")
                            )

attach(HP)
```

# Analisi dell'età delle case

Avendo il vettore delle età delle case, procedo a metterlo in relazione con il SalePrice trimite uno scatter plot

``` {r, warning = F}
mod <- lm(SalePrice ~ HouseAge)

ggplot(HP, aes(x = HouseAge, y = SalePrice)) +
    geom_point() +
    xlab("Età dell'abitazione") +
    ylab("Prezzo di vendita") +
    geom_abline(
        intercept = coef(mod)[1], 
        slope = coef(mod)[2],
        color = "red")
```

Con un p-value di `r summary(mod)[[4]][2,4]` si deduce che più la casa venduta è vecchia, più il prezzo tende a scendere. È possibile che questo sia dovuto al fatto che quando una casa si deteriora, i proprietari tendano a venderla per poco invece di ristrutturarla.


# Analisi della qualità complessiva delle case

``` {r,warning = F}

par(mfrow=c(1,1))
ggplot(HP, aes(x = OverallQual, y = SalePrice)) +
    geom_point() +
    xlab("Qualità complessiva") +
    ylab("Prezzo di vendita")

```

Si deduce che più la qualità aumenta, più il prezzo tende a aumentare. È possibile che questo sia dovuto al fatto che le persone associano alla qualità un prezzo superiore. Alla condizione "Very Excellent" si puo osservare una grande varianza, questo puo essere dovuta al fatto che ci sono pocchi dati ma anche che valutare una casa diventa piu difficile.

# Analisi della qualità esterna delle case

``` {r,warning = F}

par(mfrow=c(1,1))
ggplot(HP, aes(x = ExterQual, y = SalePrice)) +
    geom_point() +
    xlab("Qualità esterna") +
    ylab("Prezzo di vendita")

```