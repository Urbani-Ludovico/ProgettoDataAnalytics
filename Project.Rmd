---
title: "Analisi house price"
author: "Urbani Ludovico, Mohamed Fadhla Mutua, Nicoloò Nava, Nicola Batiston"
date: "2024-06-14"
output:
  word_document: default
  pdf_document: default
  html_document: default
---

# Importazione delle librerie

```{r, message = F, warning = F}
for (package in c("ggplot2", "ggcorrplot", "ggpubr", "dplyr", "GGally", "reshape2", "gridExtra", "tidyr")) {
    if (!require(package, character.only = T, quietly = T)) {
      install.packages(package, character.only = T)
    }
    
    library(package, character.only = T)
}
plot_theme = theme_minimal() +
    theme(
        plot.title = element_text(face = "bold", hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        axis.line = element_line(color = "darkgrey"),
        axis.ticks = element_line(color = "black"))
theme_set(plot_theme)
```

# Importazione dei dati

```{r, warning = F}
HP <- read.csv2(
    "./dataset.csv",
    sep = ",", 
    stringsAsFactors = T,
    row.names=1)

attach(HP)
```

# Distribuzione dei prezzi delle case

```{r, warning = F}
SalePrice.summary <- summary(SalePrice)

print(SalePrice.summary)
```

```{r, warning = F}
ggplot(HP, aes(x = SalePrice)) +
    geom_density() +
    xlab("Prezzo di vendita") +
    ylab("Densità") +
    geom_vline(aes(xintercept = SalePrice.summary["1st Qu."], colour = "1° Quantile"), linetype = "dashed") +
    geom_vline(aes(xintercept = SalePrice.summary["Mean"], colour = "Media"), linetype = "dashed") +
    geom_vline(aes(xintercept = SalePrice.summary["Median"], colour = "Mediana"), linetype = "dashed") +
    geom_vline(aes(xintercept = SalePrice.summary["3rd Qu."], colour = "3° Quantile"), linetype = "dashed") +
    labs(colour = "Statistiche") +
    scale_color_manual(labels = c("1° Quantile", "3° Quantile", "Media", "Mediana"), values = c("green", "darkgreen", "red", "blue"))
```

```{r, warning = F}
ggplot(HP, aes(x = SalePrice)) +
    geom_boxplot() +
    xlab("Prezzo di vendita")
```

Possiamo dedurre che la distribuzione è positivamente asimetrica e che la maggior parte del prezzo di vendita è compresa tra 129.975 e 214.000, essendo rispettivamente il 1° e il 3° quantile. Si può dedurre che sono una piccola parte delle case vendute siano ville di lusso, case lussuose o immobili di alto valore, ma la maggior parte del mercato immobiliare di concentri sulla vendita di piccoli o medi immobili.

# Matrice di correlazione

Prima di tutto identifico le variabili su cui ha senso fare una correlazione con il prezzo

```{r, warning = F}

Heapmap.vars <- names(HP)
selected_vars = HP[Heapmap.vars]
convert_to_numeric <- function(x) {
  if (is.factor(x) || is.character(x)) {
    as.numeric(factor(x, levels = unique(x)))
  } else {
    return(x)
  }
}

selected_data <- selected_vars %>%
  mutate(across(everything(), ~ convert_to_numeric(.))
  )

selected_data_numeric <- selected_data %>%
  mutate(across(everything(), ~ as.numeric(as.character(.))))

corHeap = as.data.frame(round(cor(selected_data_numeric, HP$SalePrice),2))

names(corHeap) = "SalePrice"

withNA = rownames(corHeap)[is.na(corHeap$SalePrice)]

for (ele in withNA){
  HP_lotfrontage = selected_data_numeric[[ele]][which(!is.na(selected_data_numeric[[ele]]))]
  HP_lotfrontageSALE = selected_data_numeric$SalePrice[which(!is.na(selected_data_numeric[[ele]]))]
  corHeap[ele,"SalePrice"] = cor(HP_lotfrontageSALE,HP_lotfrontage)
}
```

ora si può visualizzare il vettore di correlazione come

```{r, warning = F}
length_first_corHeap = ceiling(NROW(corHeap)/4)

first_half_corHeap = as.data.frame(corHeap[1:length_first_corHeap,])
rownames(first_half_corHeap) = rownames(corHeap)[1:length_first_corHeap]
names(first_half_corHeap) = "SalePrice"

length_second_corHeap = length_first_corHeap*2
second_half_corHeap = as.data.frame(corHeap[(length_first_corHeap+1):length_second_corHeap,])
rownames(second_half_corHeap) = rownames(corHeap)[(length_first_corHeap+1):length_second_corHeap]
names(second_half_corHeap) = "SalePrice"

length_third_corHeap = length_first_corHeap*3
third_half_corHeap = as.data.frame(corHeap[(length_second_corHeap+1):length_third_corHeap,])
rownames(third_half_corHeap) = rownames(corHeap)[(length_second_corHeap+1):length_third_corHeap]
names(third_half_corHeap) = "SalePrice"

length_fourth_corHeap = (length_first_corHeap*4)-1
fourth_half_corHeap = as.data.frame(corHeap[(length_third_corHeap+1):length_fourth_corHeap,])
rownames(fourth_half_corHeap) = rownames(corHeap)[(length_third_corHeap+1):length_fourth_corHeap]
names(fourth_half_corHeap) = "SalePrice"

p1 = ggcorrplot(first_half_corHeap, type = "lower", lab = TRUE, lab_size = 2.3, show.legend = F) +
  theme(
  axis.text.x = element_text(size = 7),
  axis.text.y = element_text(size = 7)
  )
p2 = ggcorrplot(second_half_corHeap, type = "lower", lab = TRUE, lab_size = 2.3, show.legend = F) +
  theme(
  axis.text.x = element_text(size = 7),
  axis.text.y = element_text(size = 7)
  )
p3 = ggcorrplot(third_half_corHeap, type = "lower", lab = TRUE, lab_size = 2.3, show.legend = T) +
  theme(
  axis.text.x = element_text(size = 7),
  axis.text.y = element_text(size = 7)
  )
p4 = ggcorrplot(fourth_half_corHeap, type = "lower", lab = TRUE, lab_size = 2.3, show.legend = F) +
  theme(
  axis.text.x = element_text(size = 7),
  axis.text.y = element_text(size = 7)
  )

get_legend <- function(myplot) {
  tmp <- ggplot_gtable(ggplot_build(myplot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)
}
legend <- get_legend(p3)
p3 = p3 + theme(legend.position = "none")

grid.arrange(
  arrangeGrob(p1, p2, p3, p4, nrow = 4),
  legend,
  ncol = 2,
  widths = c(4, 1)
)
```

e filtrarlo per avere solo le variabili che hanno correlazione con SalePrice \>=0.4

```{r, results = F, message = F, warning = F}
ggarrange(
    plotlist = lapply(
        rownames(corHeap)[rownames(corHeap) != "SalePrice" & abs(corHeap) >= 0.4],
        function (var) {
            plt <- ggplot(HP, aes(x = HP[[var]], y = SalePrice)) +
                xlab(var)
            
            if (is.factor(HP[[var]])) {
                plt <- plt + geom_boxplot()
            } else {
                plt <- plt + geom_point()
            }
            
            plot(plt)
        }),
    ncol = 2,
    nrow = 1,
    widths = c(1, 1)
)
## NA Alley -> No Alley
## NA poolQC -> No pool
```

## Variabili calcolate

Prendo le variabili escluse corro e provo a creare delle variabili calcolate che potrebbero essere correlate a SalePrice. Ad esempio variabili quantitative o qualitative che hanno valori NA o 0 per indicare l'assenza di quella caratteristica le trasformo in variabili booleane.

Trasformo le variabili opportune in factor

```{r, message = F}
HP_Excluded = HP

###' LotShape
recode_map <- c(
  "Reg" = "Regular",
  "IR1" = "Irregular",
  "IR2" = "Irregular",
  "IR3" = "Irregular"
)
HP_Excluded <- HP_Excluded %>%
  mutate(LotShapeReduced = recode(LotShape, !!!recode_map))
###' YearBuilt
current_year <- as.integer(format(Sys.Date(), "%Y"))
HP_Excluded$HouseAge <- current_year - YearBuilt
###' MSZoning
recode_map <- c(
  "A" = "Agriculture",
  "C" = "Commercial",
  "FV" = "Residential",
  "I" = "Industrial",
  "RH" = "Residential",
  "RL" = "Residential",
  "RP" = "Residential",
  "RM" = "Residential"
)
HP_Excluded <- HP_Excluded %>%
  mutate(MSZoningReduced = recode(MSZoning, !!!recode_map))
###' GarageType
recode_map <- c(
  "2Types" =	"T",
  "Attchd" =	"T",
  "Basment" =	"T",
  "BuiltIn" =	"T",
  "CarPort" =	"T",
  "Detchd" =	"T"
)
HP_Excluded <- HP_Excluded %>%
  mutate(GarageType = as.character(GarageType),
         GarageExists = recode(GarageType, !!!recode_map),
         GarageExists = replace_na(GarageExists, "F"))
HP_Excluded$GarageExists = factor(HP_Excluded$GarageExists, levels = c("F", "T"))
###' Utilities
recode_map <- c(
  "AllPub" = "All",
  "NoSewr" = "Some",
  "NoSeWa" ="Some",
  "ELO" =	"Some"
)
HP_Excluded <- HP_Excluded %>%
  mutate(UtilitiesReduced = recode(Utilities, !!!recode_map))
###' OverallCond
recode_map <- c(
  "10" = "Excellent",
  "9"	 = "Excellent",
  "8" =	"Good",
  "7"	= "Good",
  "6" =	"Average",	
  "5" =	"Average",
  "4" = "Average"	,
  "3" =	"Poor",
  "2" =	"Poor",
  "1" =	"Poor"
)
HP_Excluded <- HP_Excluded %>%
  mutate(OverallCondReduced = recode(OverallCond, !!!recode_map))
###' FireplaceQu
recode_map <- c(
  "Ex" =	"T",
  "Gd" =	"T",
  "TA" =	"T",
  "Fa" =	"T",
  "Po" =	"T"
)
HP_Excluded <- HP_Excluded %>%
  mutate(FireplaceQu = as.character(FireplaceQu),
         FirePlaceExists = recode(FireplaceQu, !!!recode_map),
         FirePlaceExists = replace_na(FirePlaceExists, "F"))
HP_Excluded$FirePlaceExists = factor(HP_Excluded$FirePlaceExists, levels = c("F", "T"))
###' BsmtCond
recode_map <- c(
  "Ex" =	"T",
  "Gd" =	"T",
  "TA" =	"T",
  "Fa" =	"T",
  "Po" =	"T"
)
HP_Excluded <- HP_Excluded %>%
  mutate(BsmtCond = as.character(BsmtCond),
         BsmtExists = recode(BsmtCond, !!!recode_map),
         BsmtExists = replace_na(BsmtExists, "F"))
HP_Excluded$BsmtExists = factor(HP_Excluded$BsmtExists, levels = c("F", "T"))
###' Fence
recode_map <- c(
  "GdPrv" =	"T",
  "MnPrv" =	"T",
  "GdWo" =	"T",
  "MnWw" =	"T"
)
HP_Excluded <- HP_Excluded %>%
  mutate(Fence = as.character(Fence),
         FenceExists = recode(Fence, !!!recode_map),
         FenceExists = replace_na(FenceExists, "F"))
HP_Excluded$FenceExists = factor(HP_Excluded$FenceExists, levels = c("F", "T"))
###' MiscFeature
recode_map <- c(
  "Elev" =	"T",
  "Gar2" =	"T",
  "Othr" =	"T",
  "Shed" =	"T",
  "TenC" =	"T"
)
HP_Excluded <- HP_Excluded %>%
  mutate(MiscFeature = as.character(MiscFeature),
         MiscFeatureExists = recode(MiscFeature, !!!recode_map),
         MiscFeatureExists = replace_na(MiscFeatureExists, "F"))
HP_Excluded$FenceExists = factor(HP_Excluded$FenceExists, levels = c("F", "T"))

attach(HP_Excluded)
```

ora procedo a metterle in correlazione con SalePrice in un heatmap

```{r, warning = F}
vars <- c("SalePrice", "LotShapeReduced", "HouseAge", "MSZoningReduced", "GarageExists", "UtilitiesReduced", "OverallCondReduced", "FirePlaceExists", "BsmtExists", "FenceExists", "MiscFeatureExists")

excludevar = HP_Excluded[vars]

selected_data <- excludevar %>%
  mutate(across(everything(), ~ convert_to_numeric(.))
  )

selected_data_numeric <- selected_data %>%
  mutate(across(everything(), ~ as.numeric(as.character(.))))

corHeap_excluded = as.data.frame(round(cor(selected_data_numeric, HP$SalePrice),2))
names(corHeap_excluded) = "SalePrice"

ggcorrplot(corHeap_excluded, type = "lower", lab = TRUE, lab_size = 2.5) + 
    theme(
        axis.text.x = element_text(size = 9),
        axis.text.y = element_text(size = 9))

```

# Analisi bivariata

## Funzioni di analisi

Visto che la variabile target SalePrice è quantitativa, distinguo due casi: 1. la seconda variabile è qualitativa:

```{r, warning = F}
analysis.qualitative <- function(target, second_var, horizontal = F, target.lab = "prezzo di vendita", second_var.lab = "seconda variabile") {
    df <- subset(data.frame(target, second_var), !is.na(second_var))
    
    test <- aov(target ~ second_var)
    p <- summary(test)[[1]][["Pr(>F)"]][1]
    
    plt <- ggplot(
        df,
        aes(
            x = if (horizontal) target else second_var, 
            y = if (horizontal) second_var else target)) +
    geom_violin(
        trim = F, 
        draw_quantiles = c(0.25, 0.5, 0.75)) +
    stat_summary(
        fun = "mean",
        geom = "point",
        color = "red",
        fill = "red",
        shape = 20,
        size = 2) +
    labs(
        title = paste(target.lab, "VS", second_var.lab, sep = " "),
        subtitle = paste("Anova p-value = ", signif(p, 3), sep = ""),
        x = if (horizontal) target.lab else second_var.lab,
        y = if (horizontal) second_var.lab else target.lab)
    
    plot(plt)
    
    return(test)
}
```

2.  la seconda variabile è quantitativa:

```{r, warning = F}
analysis.quantitative <- function(target, second_var, horizontal = F, target.lab = "prezzo di vendita", second_var.lab = "seconda variabile") {
    mod <- lm(target ~ second_var)
    p <- summary(mod)$coefficients[2,4]
    
    plt <- ggplot(
        data.frame(target, second_var),
        aes(
            x = if (horizontal) target else second_var, 
            y = if (horizontal) second_var else target)) +
    geom_point(size = 1) +
    geom_abline(
        intercept = coef(mod)[1], 
        slope = coef(mod)[2],
        color = "red") +
    labs(
        title = paste(target.lab, "VS", second_var.lab, sep = " "),
        subtitle = paste("Linear model p-value = ", signif(p, 3), sep = ""),
        x = if (horizontal) target.lab else second_var.lab,
        y = if (horizontal) second_var.lab else target.lab)
    
    plot(plt)
    
    return (mod)
}
```

## Analisi dell'età delle case

Avendo il vettore delle età delle case, procedo a metterlo in relazione con il SalePrice trimite uno scatter plot

```{r, message = F, warning = F}
mod <- analysis.quantitative(
    SalePrice, HouseAge,
    second_var.lab = "età della casa"
)
```

Con un p-value di `r summary(mod)[[4]][2,4]` si deduce che più la casa venduta è vecchia, più il prezzo tende a scendere. È possibile che questo sia dovuto al fatto che quando una casa si deteriora, i proprietari tendano a venderla per poco invece di ristrutturarla.

## Analisi della qualità complessiva delle case

```{r, message = F, warning = F}
mod <- analysis.qualitative(
    SalePrice, OverallQual,
    horizontal = T,
    second_var.lab = "qualità di costruzione"
)
```

Si deduce che più la qualità di costruzione aumenta, più il prezzo tende a aumentare. È possibile che questo sia dovuto al fatto che le persone associano alla qualità un prezzo superiore. Alla condizione "Very Excellent" si puo osservare una grande varianza, questo puo essere dovuta al fatto che ci sono pocchi dati ma anche che valutare una casa diventa piu difficile.

## Analisi della Area del Piano terra

```{r, message = F, warning = F}
mod <- analysis.quantitative(
    SalePrice, GrLivArea,
    second_var.lab = "Area del Piano terra"
)
```

Come nel punto precedente anche qua si nota che più la qualità esterna aumenta, più il prezzo tende a salire. Però si nota anche che nella classe di qualità più alta, il prezzo tende ad avere una varianza più alta.

## Analisi dei Bagni Sopra il semiterrato

```{r, message = F, warning = F}
mod <- analysis.qualitative(
    SalePrice, FullBath,
    horizontal = T,
    second_var.lab = "Bagni Sopra il semiterrato"
)
```

## Analisi dei Numeri di Stanze sopra il semiterrato

```{r, message = F, warning = F}
mod <- analysis.qualitative(
    SalePrice, TotRmsAbvGrd,
    horizontal = T,
    second_var.lab = "N Stanze sopra il semiterrato"
)
```

## Analisi dei Numeri di camini

```{r, message = F, warning = F}
mod <- analysis.qualitative(
    SalePrice, Fireplaces,
    horizontal = T,
    second_var.lab = "N di camini"
)
```

## Analisi dei Anno di costruzione dei garage

```{r, message = F, warning = F}
mod <- analysis.quantitative(
    SalePrice, GarageYrBlt,
    horizontal = F,
    second_var.lab = "Garage Year Built"
)
```

## Analisi dei Numeri di Auto

```{r, message = F, warning = F}
mod <- analysis.qualitative(
    SalePrice, GarageCars,
    horizontal = T,
    second_var.lab = "N di Auto"
)
```

## Analisi dei Area del Garage

```{r, message = F, warning = F}
mod <- analysis.quantitative(
    SalePrice, GarageArea,
    horizontal = F,
    second_var.lab = "Area del Garage"
)
```

## Analisi della Qualità delle piscine

```{r, message = F, warning = F}
mod <- analysis.qualitative(
    SalePrice, PoolQC,
    horizontal = F,
    second_var.lab = "Area del Garage"
)
```
